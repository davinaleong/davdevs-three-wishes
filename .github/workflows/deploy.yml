name: Deploy to Heroku

on:
  push:
    branches: [ main, master ]
  workflow_run:
    workflows: ["Laravel Tests"]
    branches: [ main, master ]
    types: 
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Run tests one more time before deployment as a safety check
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.3
        extensions: pdo, pdo_pgsql, pgsql

    - name: Install PHP dependencies
      run: composer install --prefer-dist --no-dev --optimize-autoloader --no-interaction

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node dependencies
      run: npm ci

    - name: Build assets
      run: npm run build

    - name: Copy environment file for testing
      run: cp .env.example .env.testing

    - name: Generate application key for testing
      run: php artisan key:generate --env=testing

    # Final test run before deployment
    - name: Final test run before deployment
      run: |
        # Use SQLite for this final check since we just need to verify tests pass
        touch database/testing.sqlite
        php artisan migrate --env=testing --force --database=testing
        php artisan test --env=testing
      env:
        DB_CONNECTION_TESTING: sqlite
        DB_DATABASE_TESTING: database/testing.sqlite

    # Deploy to Heroku only if all tests pass
    - name: Deploy to Heroku
      uses: akhileshns/heroku-deploy@v3.13.15
      with:
        heroku_api_key: ${{secrets.HEROKU_API_KEY}}
        heroku_app_name: "davdevs-three-wishes"
        heroku_email: ${{secrets.HEROKU_EMAIL}}
        buildpack: "https://github.com/heroku/heroku-buildpack-php.git"
        
    - name: Run Heroku migrations
      run: |
        # Install Heroku CLI for post-deployment tasks
        curl https://cli-assets.heroku.com/install.sh | sh
        
        # Login to Heroku
        echo "${{secrets.HEROKU_API_KEY}}" | heroku auth:token
        
        # Run migrations on Heroku
        heroku run php artisan migrate --force --app davdevs-three-wishes
        
        # Clear caches
        heroku run php artisan config:cache --app davdevs-three-wishes
        heroku run php artisan route:cache --app davdevs-three-wishes
        heroku run php artisan view:cache --app davdevs-three-wishes